<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Coding Gym</title>
<style>
/* ── Reset & base ──────────────────────────────────────────── */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --bg-primary: #1e1e2e;
  --bg-secondary: #181825;
  --bg-surface: #232336;
  --bg-surface-hover: #2a2a40;
  --border: #333350;
  --text-primary: #cdd6f4;
  --text-secondary: #a6adc8;
  --text-muted: #6c7086;
  --accent: #89b4fa;
  --accent-hover: #74c7ec;
  --green: #a6e3a1;
  --red: #f38ba8;
  --yellow: #f9e2af;
  --peach: #fab387;
  --font-mono: 'SF Mono', 'Cascadia Code', 'Fira Code', 'JetBrains Mono', Consolas, monospace;
  --font-sans: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
  --radius: 8px;
}
html, body { height: 100%; font-family: var(--font-sans); background: var(--bg-primary); color: var(--text-primary); }

/* ── Layout ────────────────────────────────────────────────── */
.app { display: flex; flex-direction: column; height: 100vh; }
.header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 0 20px; height: 48px; min-height: 48px;
  background: var(--bg-secondary); border-bottom: 1px solid var(--border);
}
.header-left { display: flex; align-items: center; gap: 16px; }
.header-title { font-size: 14px; font-weight: 600; color: var(--accent); letter-spacing: 0.5px; }
.header-right { display: flex; align-items: center; gap: 10px; }
.header-challenge { font-size: 13px; color: var(--text-secondary); }
.header-badge {
  display: inline-block; padding: 2px 8px; border-radius: 10px;
  font-size: 11px; font-weight: 600; margin-left: 10px;
  background: rgba(166,227,161,0.15); color: var(--green);
}
.header-badge.medium { background: rgba(249,226,175,0.15); color: var(--yellow); }
.header-badge.hard { background: rgba(243,139,168,0.15); color: var(--red); }

/* ── Challenge selector ────────────────────────────────────── */
#challengeSelector {
  padding: 5px 10px; border: 1px solid var(--border); border-radius: var(--radius);
  background: var(--bg-surface); color: var(--text-primary);
  font-size: 13px; font-family: var(--font-sans); cursor: pointer;
  outline: none; transition: border-color 0.15s;
}
#challengeSelector:hover { border-color: var(--accent); }
#challengeSelector:focus { border-color: var(--accent); }
#challengeSelector option { background: var(--bg-surface); color: var(--text-primary); }

.main { display: flex; flex: 1; overflow: hidden; }

/* ── Left panel: Problem ───────────────────────────────────── */
.panel-left {
  width: 42%; min-width: 320px; display: flex; flex-direction: column;
  border-right: 1px solid var(--border); background: var(--bg-secondary);
}
.panel-left-header {
  padding: 12px 20px; border-bottom: 1px solid var(--border);
  font-size: 12px; font-weight: 600; text-transform: uppercase;
  letter-spacing: 1px; color: var(--text-muted);
}
.problem-content {
  flex: 1; overflow-y: auto; padding: 20px;
  font-size: 14px; line-height: 1.7; color: var(--text-primary);
}
.problem-content h2 { font-size: 20px; margin: 0 0 12px; color: var(--text-primary); }
.problem-content h3 { font-size: 15px; margin: 20px 0 8px; color: var(--accent); }
.problem-content p { margin: 8px 0; }
.problem-content ul, .problem-content ol { margin: 8px 0 8px 20px; }
.problem-content li { margin: 4px 0; }
.problem-content code {
  background: var(--bg-surface); padding: 2px 6px; border-radius: 4px;
  font-family: var(--font-mono); font-size: 13px; color: var(--peach);
}
.problem-content strong { color: var(--yellow); }

.scoring-section {
  border-top: 1px solid var(--border); padding: 16px 20px;
}
.scoring-section h4 { font-size: 13px; margin-bottom: 10px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
.scoring-row {
  display: flex; justify-content: space-between; align-items: center;
  padding: 6px 0; font-size: 13px;
}
.scoring-row .name { color: var(--text-secondary); }
.scoring-row .pts { color: var(--accent); font-weight: 600; font-family: var(--font-mono); }

/* ── Right panel: Editor + Agent ───────────────────────────── */
.panel-right { flex: 1; display: flex; flex-direction: column; min-width: 400px; }

/* Editor area */
.editor-header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 8px 16px; border-bottom: 1px solid var(--border);
  background: var(--bg-secondary);
}
.editor-filename { font-family: var(--font-mono); font-size: 13px; color: var(--text-secondary); }
.editor-actions { display: flex; gap: 8px; }
.btn {
  padding: 6px 16px; border: none; border-radius: var(--radius);
  font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.15s;
  font-family: var(--font-sans);
}
.btn-run { background: rgba(137,180,250,0.15); color: var(--accent); }
.btn-run:hover { background: rgba(137,180,250,0.25); }
.btn-submit { background: rgba(166,227,161,0.15); color: var(--green); }
.btn-submit:hover { background: rgba(166,227,161,0.25); }
.btn:disabled { opacity: 0.4; cursor: not-allowed; }

.editor-wrapper { flex: 1; position: relative; overflow: hidden; }
#code-editor {
  width: 100%; height: 100%; resize: none; border: none; outline: none;
  background: var(--bg-primary); color: var(--text-primary);
  font-family: var(--font-mono); font-size: 13px; line-height: 1.6;
  padding: 16px; tab-size: 4;
}

/* Output panel */
.output-panel {
  border-top: 1px solid var(--border); background: var(--bg-secondary);
  max-height: 200px; overflow: hidden; display: flex; flex-direction: column;
}
.output-panel.expanded { max-height: 300px; }
.output-header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 8px 16px; border-bottom: 1px solid var(--border);
  cursor: pointer; user-select: none;
}
.output-header h4 { font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); }
.output-status { font-size: 12px; font-weight: 600; }
.output-status.success { color: var(--green); }
.output-status.error { color: var(--red); }
.output-status.running { color: var(--yellow); }
.output-body {
  flex: 1; overflow-y: auto; padding: 12px 16px;
  font-family: var(--font-mono); font-size: 12px; line-height: 1.5;
  white-space: pre-wrap; color: var(--text-secondary);
}

/* ── Agent prompt ──────────────────────────────────────────── */
.agent-panel {
  border-top: 1px solid var(--border); background: var(--bg-surface);
  padding: 12px 16px; display: flex; flex-direction: column; gap: 8px;
}
.agent-label {
  font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px;
  color: var(--text-muted); font-weight: 600;
}
.agent-input-row { display: flex; gap: 8px; }
#agent-input {
  flex: 1; padding: 10px 14px; border: 1px solid var(--border); border-radius: var(--radius);
  background: var(--bg-primary); color: var(--text-primary);
  font-size: 13px; font-family: var(--font-sans); outline: none;
  transition: border-color 0.15s;
}
#agent-input:focus { border-color: var(--accent); }
#agent-input::placeholder { color: var(--text-muted); }
.btn-agent {
  padding: 10px 20px; border: none; border-radius: var(--radius);
  background: var(--accent); color: var(--bg-primary);
  font-size: 13px; font-weight: 600; cursor: pointer;
  transition: background 0.15s; white-space: nowrap;
}
.btn-agent:hover { background: var(--accent-hover); }
.btn-agent:disabled { opacity: 0.4; cursor: not-allowed; }
.agent-status { font-size: 12px; color: var(--text-muted); min-height: 18px; }
.agent-status.thinking { color: var(--yellow); }

/* ── Grading result overlay ────────────────────────────────── */
.result-overlay {
  display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.6); z-index: 100; align-items: center; justify-content: center;
}
.result-overlay.visible { display: flex; }
.result-card {
  background: var(--bg-surface); border: 1px solid var(--border);
  border-radius: 12px; padding: 32px; max-width: 500px; width: 90%;
  max-height: 80vh; overflow-y: auto;
}
.result-card h2 { font-size: 20px; margin-bottom: 8px; }
.result-card .score-big {
  font-size: 48px; font-weight: 700; font-family: var(--font-mono);
  margin: 16px 0;
}
.result-card .score-big.passed { color: var(--green); }
.result-card .score-big.failed { color: var(--red); }
.result-card .category {
  padding: 10px 0; border-top: 1px solid var(--border);
  display: flex; justify-content: space-between; align-items: start;
}
.result-card .cat-name { font-weight: 600; font-size: 14px; }
.result-card .cat-score { font-family: var(--font-mono); font-weight: 600; color: var(--accent); }
.result-card .cat-feedback { font-size: 12px; color: var(--text-muted); margin-top: 4px; }
.btn-close-result {
  margin-top: 20px; width: 100%; padding: 10px; border: 1px solid var(--border);
  border-radius: var(--radius); background: transparent; color: var(--text-primary);
  font-size: 14px; cursor: pointer;
}
.btn-close-result:hover { background: var(--bg-surface-hover); }

/* ── Scrollbar ─────────────────────────────────────────────── */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

/* ── Loading spinner ───────────────────────────────────────── */
@keyframes spin { to { transform: rotate(360deg); } }
.spinner {
  display: inline-block; width: 14px; height: 14px;
  border: 2px solid var(--border); border-top-color: var(--accent);
  border-radius: 50%; animation: spin 0.6s linear infinite;
  vertical-align: middle; margin-right: 6px;
}
</style>
</head>
<body>

<div class="app">
  <!-- Header -->
  <div class="header">
    <div class="header-left">
      <div class="header-title">AI Coding Gym</div>
      <select id="challengeSelector" onchange="switchChallenge(this.value)">
        <option value="">Loading challenges...</option>
      </select>
    </div>
    <div class="header-right">
      <span class="header-challenge" id="header-challenge">Loading...</span>
      <span class="header-badge" id="header-badge"></span>
    </div>
  </div>

  <!-- Main panels -->
  <div class="main">
    <!-- Left: Problem description -->
    <div class="panel-left">
      <div class="panel-left-header">Problem Description</div>
      <div class="problem-content" id="problem-content">Loading challenge...</div>
      <div class="scoring-section" id="scoring-section"></div>
    </div>

    <!-- Right: Editor + Output + Agent -->
    <div class="panel-right">
      <!-- Editor header -->
      <div class="editor-header">
        <span class="editor-filename">solution.py</span>
        <div class="editor-actions">
          <button class="btn btn-run" id="btn-run" onclick="runCode()">Run</button>
          <button class="btn btn-submit" id="btn-submit" onclick="submitCode()">Submit</button>
        </div>
      </div>

      <!-- Code editor -->
      <div class="editor-wrapper">
        <textarea id="code-editor" spellcheck="false" placeholder="# Your code here..."></textarea>
      </div>

      <!-- Output -->
      <div class="output-panel" id="output-panel">
        <div class="output-header" onclick="toggleOutput()">
          <h4>Output</h4>
          <span class="output-status" id="output-status"></span>
        </div>
        <div class="output-body" id="output-body">Click "Run" to test your code or "Submit" for full grading.</div>
      </div>

      <!-- Agent prompt -->
      <div class="agent-panel">
        <div class="agent-label">AI Agent</div>
        <div class="agent-input-row">
          <input type="text" id="agent-input"
            placeholder="Describe your approach to the agent -- it will write code for you..."
            onkeydown="if(event.key==='Enter')sendToAgent()">
          <button class="btn-agent" id="btn-agent" onclick="sendToAgent()">Send</button>
        </div>
        <div class="agent-status" id="agent-status"></div>
      </div>
    </div>
  </div>
</div>

<!-- Grading result overlay -->
<div class="result-overlay" id="result-overlay" onclick="if(event.target===this)closeResult()">
  <div class="result-card" id="result-card"></div>
</div>

<script>
// ── State ──────────────────────────────────────────────────────
let challengeId = '';
let challengeData = null;
let agentHistory = [];
const API = '/api';

// ── Challenge display names and icons ──────────────────────────
const CHALLENGE_ICONS = {
  'email-spam-detection': '\u{1F4E7}',
  'mnist_digit_recognition': '\u{1F522}',
};

// ── API helpers ────────────────────────────────────────────────
async function api(method, path, body) {
  const opts = { method, headers: { 'Content-Type': 'application/json' } };
  if (body) opts.body = JSON.stringify(body);
  const resp = await fetch(`${API}${path}`, opts);
  return resp.json();
}

// ── Load challenge list and populate selector ──────────────────
async function loadChallengeList() {
  try {
    const result = await api('GET', '/challenges');
    const challenges = result.challenges || [];
    const selector = document.getElementById('challengeSelector');
    selector.innerHTML = '';

    if (challenges.length === 0) {
      selector.innerHTML = '<option value="">No challenges available</option>';
      return;
    }

    challenges.forEach(c => {
      const icon = CHALLENGE_ICONS[c.id] || '\u{1F4CB}';
      const opt = document.createElement('option');
      opt.value = c.id;
      opt.textContent = `${icon} ${c.title}`;
      selector.appendChild(opt);
    });

    // Load the first challenge by default
    challengeId = challenges[0].id;
    selector.value = challengeId;
    await loadChallenge(challengeId);
  } catch (e) {
    document.getElementById('problem-content').textContent = 'Failed to load challenges.';
    console.error('Failed to load challenge list:', e);
  }
}

// ── Switch challenge ───────────────────────────────────────────
async function switchChallenge(newId) {
  if (!newId || newId === challengeId) return;
  challengeId = newId;
  agentHistory = [];

  // Clear output
  document.getElementById('output-status').textContent = '';
  document.getElementById('output-status').className = 'output-status';
  document.getElementById('output-body').textContent = 'Click "Run" to test your code or "Submit" for full grading.';
  document.getElementById('agent-status').textContent = '';

  await loadChallenge(challengeId);
}

// ── Load challenge ─────────────────────────────────────────────
async function loadChallenge(id) {
  try {
    challengeData = await api('GET', `/challenges/${id}`);
    document.getElementById('header-challenge').textContent = challengeData.title;

    const badge = document.getElementById('header-badge');
    badge.textContent = challengeData.difficulty.toUpperCase();
    badge.className = 'header-badge';
    if (challengeData.difficulty === 'medium') badge.classList.add('medium');
    else if (challengeData.difficulty === 'hard') badge.classList.add('hard');

    document.getElementById('code-editor').value = challengeData.starter_code;
    renderProblem(challengeData);
    renderScoring(challengeData);
  } catch (e) {
    document.getElementById('problem-content').textContent = 'Failed to load challenge.';
    console.error('Failed to load challenge:', e);
  }
}

function renderProblem(data) {
  // Simple markdown-ish rendering
  let html = data.description
    .replace(/^## (.+)$/gm, '<h2>$1</h2>')
    .replace(/^### (.+)$/gm, '<h3>$1</h3>')
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
    .replace(/`([^`]+)`/g, '<code>$1</code>')
    .replace(/^- (.+)$/gm, '<li>$1</li>')
    .replace(/^(\d+)\. (.+)$/gm, '<li>$2</li>')
    .replace(/(<li>.*<\/li>\n?)+/gs, (m) => `<ul>${m}</ul>`)
    .replace(/\n\n/g, '</p><p>')
    .replace(/\n/g, ' ');
  html = '<p>' + html + '</p>';

  // Add allowed libraries
  if (data.allowed_libraries && data.allowed_libraries.length) {
    html += `<h3>Allowed Libraries</h3><p><code>${data.allowed_libraries.join('</code>, <code>')}</code></p>`;
  }

  // Add examples
  if (data.examples && data.examples.length) {
    html += '<h3>Examples</h3>';
    data.examples.forEach(ex => {
      const inputStr = typeof ex.input === 'string' ? ex.input : JSON.stringify(ex.input);
      const label = ex.label || String(ex.output);
      html += `<p><code>${escapeHtml(inputStr.substring(0, 80))}${inputStr.length > 80 ? '...' : ''}</code> &rarr; <strong>${escapeHtml(label)}</strong> (${ex.output})</p>`;
    });
  }

  document.getElementById('problem-content').innerHTML = html;
}

function renderScoring(data) {
  if (!data.scoring || !data.scoring.categories) return;
  let html = '<h4>Scoring Rubric</h4>';
  data.scoring.categories.forEach(cat => {
    html += `<div class="scoring-row"><span class="name">${escapeHtml(cat.name)}</span><span class="pts">${cat.max_points} pts</span></div>`;
  });
  html += `<div class="scoring-row" style="border-top:1px solid var(--border);padding-top:8px;margin-top:4px"><span class="name" style="font-weight:600">Total</span><span class="pts">${data.scoring.max_score} pts (pass: ${data.scoring.pass_threshold}+)</span></div>`;
  document.getElementById('scoring-section').innerHTML = html;
}

function escapeHtml(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ── Run code ───────────────────────────────────────────────────
async function runCode() {
  const code = document.getElementById('code-editor').value;
  const btn = document.getElementById('btn-run');
  const status = document.getElementById('output-status');
  const body = document.getElementById('output-body');

  btn.disabled = true;
  btn.textContent = 'Running...';
  status.className = 'output-status running';
  status.innerHTML = '<span class="spinner"></span>Running...';
  body.textContent = 'Executing code on training sample...';
  document.getElementById('output-panel').classList.add('expanded');

  try {
    const result = await api('POST', `/challenges/${challengeId}/run`, { code });
    if (result.success) {
      status.className = 'output-status success';
      status.textContent = `Passed (${result.execution_time}s)`;
      let out = '';
      if (result.stdout) out += result.stdout + '\n';
      out += `\nSample accuracy: ${(result.sample_accuracy * 100).toFixed(2)}%`;
      out += `\nTrain time: ${result.train_time}s`;
      out += `\nTotal execution: ${result.execution_time}s`;
      body.textContent = out;
    } else {
      status.className = 'output-status error';
      status.textContent = 'Error';
      let out = result.error || 'Unknown error';
      if (result.traceback) out += '\n\n' + result.traceback;
      if (result.stderr) out += '\n\nStderr:\n' + result.stderr;
      body.textContent = out;
    }
  } catch (e) {
    status.className = 'output-status error';
    status.textContent = 'Network Error';
    body.textContent = 'Failed to connect to server: ' + e.message;
  } finally {
    btn.disabled = false;
    btn.textContent = 'Run';
  }
}

// ── Submit code ────────────────────────────────────────────────
async function submitCode() {
  const code = document.getElementById('code-editor').value;
  const btn = document.getElementById('btn-submit');
  const status = document.getElementById('output-status');
  const body = document.getElementById('output-body');

  btn.disabled = true;
  btn.textContent = 'Submitting...';
  status.className = 'output-status running';
  status.innerHTML = '<span class="spinner"></span>Grading...';
  body.textContent = 'Training model and evaluating on hidden test set...';
  document.getElementById('output-panel').classList.add('expanded');

  try {
    const result = await api('POST', `/challenges/${challengeId}/submit`, { code });
    if (result.success && result.grading) {
      const g = result.grading;
      status.className = g.passed ? 'output-status success' : 'output-status error';
      status.textContent = `${g.total_score}/${g.max_score} ${g.passed ? 'PASSED' : 'FAILED'}`;

      let out = '';
      if (result.stdout) out += result.stdout + '\n';
      out += `\nScore: ${g.total_score}/${g.max_score} ${g.passed ? 'PASSED' : 'FAILED'}`;
      if (g.accuracy != null) out += `\nAccuracy: ${(g.accuracy * 100).toFixed(2)}%`;
      out += `\nExecution: ${result.execution_time}s`;
      body.textContent = out;

      showGradingResult(g);
    } else {
      status.className = 'output-status error';
      status.textContent = 'Error';
      let out = result.error || 'Unknown error';
      if (result.traceback) out += '\n\n' + result.traceback;
      body.textContent = out;
    }
  } catch (e) {
    status.className = 'output-status error';
    status.textContent = 'Network Error';
    body.textContent = 'Failed to connect to server: ' + e.message;
  } finally {
    btn.disabled = false;
    btn.textContent = 'Submit';
  }
}

// ── Grading result overlay ─────────────────────────────────────
function showGradingResult(grading) {
  const card = document.getElementById('result-card');
  const passed = grading.passed;
  let html = `<h2>${passed ? 'Accepted' : 'Not Passed'}</h2>`;
  html += `<div class="score-big ${passed ? 'passed' : 'failed'}">${grading.total_score}/${grading.max_score}</div>`;

  grading.categories.forEach(cat => {
    html += `<div class="category"><div><div class="cat-name">${escapeHtml(cat.name)}</div>`;
    if (cat.feedback && cat.feedback.length) {
      html += `<div class="cat-feedback">${cat.feedback.map(escapeHtml).join('<br>')}</div>`;
    }
    html += `</div><div class="cat-score">${cat.score}/${cat.max_score}</div></div>`;
  });

  html += `<button class="btn-close-result" onclick="closeResult()">Close</button>`;
  card.innerHTML = html;
  document.getElementById('result-overlay').classList.add('visible');
}

function closeResult() {
  document.getElementById('result-overlay').classList.remove('visible');
}

function toggleOutput() {
  document.getElementById('output-panel').classList.toggle('expanded');
}

// ── Agent ──────────────────────────────────────────────────────
async function sendToAgent() {
  const input = document.getElementById('agent-input');
  const btn = document.getElementById('btn-agent');
  const statusEl = document.getElementById('agent-status');
  const message = input.value.trim();
  if (!message) return;

  const currentCode = document.getElementById('code-editor').value;

  btn.disabled = true;
  input.disabled = true;
  statusEl.className = 'agent-status thinking';
  statusEl.innerHTML = '<span class="spinner"></span>Agent is thinking...';

  try {
    const result = await api('POST', '/agent/chat', {
      challenge_id: challengeId,
      message: message,
      current_code: currentCode,
      history: agentHistory,
    });

    if (result.error) {
      statusEl.className = 'agent-status';
      statusEl.textContent = 'Error: ' + result.error;
      return;
    }

    // Update editor with generated code
    if (result.code) {
      document.getElementById('code-editor').value = result.code;
    }

    // Update history
    agentHistory.push({ role: 'user', content: message });
    agentHistory.push({ role: 'assistant', content: result.code || result.message });

    // Show status
    statusEl.className = 'agent-status';
    if (result.message) {
      statusEl.textContent = result.message.substring(0, 150) + (result.message.length > 150 ? '...' : '');
    } else {
      statusEl.textContent = 'Code updated in editor. Click "Run" to test it.';
    }

    input.value = '';
  } catch (e) {
    statusEl.className = 'agent-status';
    statusEl.textContent = 'Failed to reach agent: ' + e.message;
  } finally {
    btn.disabled = false;
    input.disabled = false;
    input.focus();
  }
}

// ── Tab key support in editor ──────────────────────────────────
document.getElementById('code-editor').addEventListener('keydown', function(e) {
  if (e.key === 'Tab') {
    e.preventDefault();
    const s = this.selectionStart;
    const end = this.selectionEnd;
    this.value = this.value.substring(0, s) + '    ' + this.value.substring(end);
    this.selectionStart = this.selectionEnd = s + 4;
  }
});

// ── Init ───────────────────────────────────────────────────────
loadChallengeList();
</script>
</body>
</html>
